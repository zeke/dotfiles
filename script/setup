#!/bin/bash
set -e

cd ~

if ! command -v brew &> /dev/null; then
  echo "Installing Homebrew..."
  /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
  eval "$(/opt/homebrew/bin/brew shellenv)"
fi

echo "Creating symlinks..."
ln -sf ~/git/zeke/dotfiles/.zshrc .zshrc
ln -sf ~/git/zeke/dotfiles/.gitignore_global .gitignore_global
ln -sf ~/git/zeke/dotfiles/.claude .claude

echo "Sourcing .zshrc..."
(source ~/.zshrc 2>/dev/null) || true

echo "Configuring git..."
git config --global core.excludesfile ~/.gitignore_global
git config --global user.name "Zeke Sikelianos"
git config --global user.email zeke@sikelianos.com
git config --global hub.protocol https
git config --global init.defaultBranch main

echo "Setting up VS Code..."
mkdir -p ~/Library/Application\ Support/Code/User
ln -sf ~/git/zeke/dotfiles/vscode/settings.json ~/Library/Application\ Support/Code/User/settings.json
ln -sf ~/git/zeke/dotfiles/vscode/keybindings.json ~/Library/Application\ Support/Code/User/keybindings.json

echo "Creating secrets file if it doesn't exist..."
touch ~/git/zeke/dotfiles/env.sh

echo "Installing Homebrew packages..."
brew bundle --file=~/git/zeke/dotfiles/Brewfile --verbose

echo "Configuring npm..."
npm config set init-author-name "Zeke Sikelianos"
npm config set init-author-email zeke@sikelianos.com
npm config set init-author-url http://zeke.sikelianos.com
npm config set init-license MIT

echo "Installing global npm packages..."
npm_packages="trymodule npe json shrug ghwd"
for pkg in $npm_packages; do
  if ! npm list -g "$pkg" &>/dev/null; then
    npm i -g "$pkg"
  else
    echo "Using $pkg"
  fi
done

echo "Done!"
echo "Run 'source ~/.zshrc' or open a new terminal to ensure all shell changes are applied."
echo "Install Snazzy theme for Terminal.app: https://github.com/sindresorhus/terminal-snazzy"
