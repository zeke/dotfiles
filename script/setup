#!/bin/bash
set -e

SKIP_BREW_UPDATE=0
for arg in "$@"; do
  case "$arg" in
    --skip-brew-update)
      SKIP_BREW_UPDATE=1
      ;;
  esac
done

cd ~

if ! command -v brew &> /dev/null; then
  echo "Installing Homebrew..."
  /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
  eval "$(/opt/homebrew/bin/brew shellenv)"
fi

if [ "$SKIP_BREW_UPDATE" -eq 1 ]; then
  export HOMEBREW_NO_AUTO_UPDATE=1
  export HOMEBREW_NO_INSTALL_UPGRADE=1
fi

echo "Creating symlinks..."
ln -sf ~/git/zeke/dotfiles/.zshrc .zshrc
ln -sf ~/git/zeke/dotfiles/.hushlogin .hushlogin
ln -sf ~/git/zeke/dotfiles/.gitconfig .gitconfig
ln -sf ~/git/zeke/dotfiles/.gitconfig-work .gitconfig-work
ln -sf ~/git/zeke/dotfiles/.gitignore_global .gitignore_global
ln -sf ~/git/zeke/dotfiles/.claude .claude
mkdir -p ~/.config/opencode
while true; do
  read -r -p "Choose OpenCode profile (work/play): " opencode_profile
  case "$opencode_profile" in
    work)
      opencode_config=~/git/zeke/dotfiles/opencode/opencode.work.json
      break
      ;;
    play)
      opencode_config=~/git/zeke/dotfiles/opencode/opencode.play.json
      break
      ;;
    *)
      echo "Please enter 'work' or 'play'."
      ;;
  esac
done
echo "Using OpenCode profile: $opencode_profile"
ln -sf "$opencode_config" ~/.config/opencode/opencode.json

echo "Sourcing .zshrc..."
(source ~/.zshrc 2>/dev/null) || true

echo "Installing git hooks for dotfiles repo..."
ln -sf ~/git/zeke/dotfiles/git/pre-commit ~/git/zeke/dotfiles/.git/hooks/pre-commit

echo "Setting up VS Code..."
mkdir -p ~/Library/Application\ Support/Code/User
ln -sf ~/git/zeke/dotfiles/vscode/settings.json ~/Library/Application\ Support/Code/User/settings.json
ln -sf ~/git/zeke/dotfiles/vscode/keybindings.json ~/Library/Application\ Support/Code/User/keybindings.json

echo "Creating secrets file if it doesn't exist..."
touch ~/git/zeke/dotfiles/env.sh

echo "Installing Homebrew packages..."
brew bundle --file=~/git/zeke/dotfiles/Brewfile --verbose

echo "Configuring npm..."
npm config set init-author-name "Zeke Sikelianos"
npm config set init-author-email zeke@sikelianos.com
npm config set init-author-url http://zeke.sikelianos.com
npm config set init-license MIT

echo "Installing global npm packages..."
npm_packages="trymodule npe json shrug ghwd"
for pkg in $npm_packages; do
  if ! npm list -g "$pkg" &>/dev/null; then
    npm i -g "$pkg"
  else
    echo "Using $pkg"
  fi
done

echo "Setting up Ghostty configuration..."
mkdir -p ~/.config/ghostty
ln -sf ~/git/zeke/dotfiles/ghostty/config ~/.config/ghostty/config

echo "Done!"
echo "Run 'source ~/.zshrc' or open a new terminal to ensure all shell changes are applied."
